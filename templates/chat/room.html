{% extends 'base.html' %}

{% block title %}Chat - {{ room_name }}{% endblock %}

{% block content %}
<!-- Chat Header -->
<div class="mb-6">
  <div class="bg-gradient-to-r from-emerald-50 via-teal-50 to-cyan-50 rounded-3xl p-6 border border-emerald-100/50 shadow-sm">
    <div class="flex items-center justify-between">
      <div class="flex items-center space-x-4">
        <div class="w-12 h-12 bg-gradient-to-br from-emerald-500 to-teal-500 rounded-2xl flex items-center justify-center shadow-lg">
          <i class="fas fa-comments text-white text-lg"></i>
        </div>
        <div>
          <h1 class="text-2xl font-bold bg-gradient-to-r from-emerald-600 to-teal-600 bg-clip-text text-transparent">
            {{ room_name }}
          </h1>
          <p class="text-gray-600">Real-time conversation â€¢ {{ participants|length }} participants</p>
        </div>
      </div>
      <div class="flex items-center space-x-2">
        <div class="w-3 h-3 bg-green-400 rounded-full animate-pulse"></div>
        <span class="text-sm text-green-600 font-medium">Live</span>
      </div>
    </div>
  </div>
</div>

<div class="grid grid-cols-1 xl:grid-cols-12 gap-8">
  <!-- Chat Area -->
  <div class="xl:col-span-8">
    <div class="bg-white/80 backdrop-blur-sm rounded-3xl shadow-xl border border-white/20 overflow-hidden">
      <!-- Chat Header -->
      <div class="bg-gradient-to-r from-emerald-500/10 to-teal-500/10 px-6 py-4">
              <div class="flex items-center justify-between">
        <div class="flex items-center space-x-3">
          <div class="p-2 bg-gradient-to-br from-emerald-400 to-teal-400 rounded-2xl shadow-lg">
            <i class="fas fa-messages text-white text-sm"></i>
          </div>
          <h3 class="font-bold text-gray-800">Messages</h3>
        </div>
        <div class="flex items-center space-x-3">
          {% if room.created_by == user %}
          <a href="{% url 'delete_chat_room' room_name %}" 
             class="inline-flex items-center px-3 py-1 bg-gradient-to-r from-red-500 to-pink-500 hover:from-red-600 hover:to-pink-600 text-white text-sm font-medium rounded-xl shadow-md hover:shadow-lg transform hover:scale-105 transition-all duration-300"
             onclick="return confirm('Are you sure you want to delete this chat room? This action cannot be undone and all participants will be notified.')">
            <i class="fas fa-trash mr-1"></i> Delete Room
          </a>
          {% endif %}
          <div class="flex items-center space-x-2 text-sm text-gray-500">
            <i class="fas fa-shield-alt text-green-500"></i>
            <span>End-to-end encrypted</span>
          </div>
        </div>
      </div>
      </div>
      
      <!-- Messages Container -->
      <div class="px-6 py-4">
        <div
          id="chat-messages"
          class="chat-messages mb-6 p-4 bg-gradient-to-br from-gray-50 to-gray-50/50 rounded-2xl border border-gray-100 overflow-y-auto space-y-3"
          style="height: 450px"
        >
          {% for message in messages %}
          <div class="flex {% if message.sender == user %}justify-end{% else %}justify-start{% endif %}">
            <div class="max-w-xs lg:max-w-md">
              <div class="{% if message.sender == user %}bg-gradient-to-r from-blue-500 to-indigo-500 text-white rounded-2xl rounded-br-md{% else %}bg-white border border-gray-200 text-gray-800 rounded-2xl rounded-bl-md{% endif %} px-4 py-3 shadow-md">
                <div class="font-medium text-sm mb-1">
                  {% if message.sender == user %}
                    You
                  {% else %}
                    {{ message.sender.username }}
                  {% endif %}
                </div>
                <div class="{% if message.sender == user %}text-white{% else %}text-gray-700{% endif %}">
                  {{ message.content }}
                </div>
                <div class="text-xs {% if message.sender == user %}text-blue-100{% else %}text-gray-500{% endif %} mt-1">
                  {{ message.timestamp|date:"H:i" }}
                </div>
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
        
        <!-- Message Input -->
        <form id="chat-form" class="flex space-x-3">
          <div class="flex-1 relative">
            <input
              type="text"
              id="chat-message-input"
              class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-2xl focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-transparent focus:bg-white transition-all duration-300 pr-12"
              placeholder="Type your message..."
            />
            <button
              type="button"
              class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-emerald-500 transition-colors"
              onclick="document.getElementById('chat-message-input').value += 'ðŸ˜Š'"
            >
              <i class="fas fa-smile"></i>
            </button>
          </div>
          <button
            class="bg-gradient-to-r from-emerald-500 to-teal-500 hover:from-emerald-600 hover:to-teal-600 text-white font-semibold px-6 py-3 rounded-2xl shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300 flex items-center space-x-2"
            type="submit"
          >
            <i class="fas fa-paper-plane"></i>
            <span class="hidden sm:inline">Send</span>
          </button>
        </form>
      </div>
    </div>
  </div>

  <!-- Participants Sidebar -->
  <div class="xl:col-span-4">
    <div class="bg-white/80 backdrop-blur-sm rounded-3xl shadow-xl border border-white/20 overflow-hidden">
      <!-- Participants Header -->
      <div class="bg-gradient-to-r from-blue-500/10 to-indigo-500/10 px-6 py-4">
        <div class="flex items-center justify-between">
          <div class="flex items-center space-x-3">
            <div class="p-2 bg-gradient-to-br from-blue-400 to-indigo-400 rounded-2xl shadow-lg">
              <i class="fas fa-users text-white text-sm"></i>
            </div>
            <h3 class="font-bold text-gray-800">Participants</h3>
          </div>
          <span class="bg-blue-100 text-blue-700 px-3 py-1 rounded-full text-sm font-medium">{{ participants|length }}</span>
        </div>
      </div>
      
      <!-- Participants List -->
      <div class="px-6 py-6 space-y-4">
        {% for participant in participants %}
        <div class="flex items-center space-x-3 p-3 bg-gradient-to-r from-gray-50 to-gray-50/50 rounded-2xl border border-gray-100 hover:border-blue-200 hover:shadow-md transition-all duration-300">
          {% if participant.profile_picture %}
          <img
            src="{{ participant.profile_picture.url }}"
            class="w-10 h-10 rounded-full object-cover ring-2 ring-gray-200"
          />
          {% else %}
          <div class="w-10 h-10 bg-gradient-to-br from-purple-400 to-pink-400 rounded-full flex items-center justify-center shadow-md">
            <i class="fas fa-user text-white text-sm"></i>
          </div>
          {% endif %}
          
          <div class="flex-1 min-w-0">
            <div class="font-semibold text-gray-800 truncate">
              {{ participant.get_full_name|default:participant.username }}
              {% if participant == user %}
              <span class="text-xs bg-emerald-100 text-emerald-700 px-2 py-1 rounded-full ml-2">You</span>
              {% endif %}
            </div>
            <div class="text-sm text-gray-500">@{{ participant.username }}</div>
          </div>
          
          <!-- Online Status -->
          <div class="flex items-center space-x-1">
            <div class="w-2 h-2 bg-green-400 rounded-full"></div>
            <span class="text-xs text-green-600">Online</span>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
    
    <!-- Quick Actions -->
    <div class="mt-6 bg-white/80 backdrop-blur-sm rounded-3xl shadow-xl border border-white/20 overflow-hidden">
      <div class="bg-gradient-to-r from-purple-500/10 to-pink-500/10 px-6 py-4">
        <div class="flex items-center space-x-3">
          <div class="p-2 bg-gradient-to-br from-purple-400 to-pink-400 rounded-2xl shadow-lg">
            <i class="fas fa-bolt text-white text-sm"></i>
          </div>
          <h3 class="font-bold text-gray-800">Quick Actions</h3>
        </div>
      </div>
      
      <div class="px-6 py-6 space-y-3">
        <a href="{% url 'chat_list' %}" class="block w-full text-center px-4 py-3 bg-gradient-to-r from-gray-100 to-gray-100/50 text-gray-700 font-medium rounded-2xl hover:shadow-md transition-all duration-300">
          <i class="fas fa-arrow-left mr-2"></i>
          Back to Rooms
        </a>
        <button onclick="copyRoomLink()" class="block w-full text-center px-4 py-3 bg-gradient-to-r from-blue-50 to-indigo-50 text-blue-700 font-medium rounded-2xl hover:shadow-md transition-all duration-300 border border-blue-200">
          <i class="fas fa-share mr-2"></i>
          Share Room
        </button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
  const roomName = "{{ room_name }}";
  const encodedRoomName = encodeURIComponent(roomName);

  // WebSocket connection with proper protocol detection
  const protocol = window.location.protocol === "https:" ? "wss:" : "ws:";
  const chatSocket = new WebSocket(
    protocol + "//" + window.location.host + "/ws/chat/" + encodedRoomName + "/"
  );

  chatSocket.onmessage = function (e) {
    const data = JSON.parse(e.data);
    const messagesContainer = document.getElementById("chat-messages");
    const messageDiv = document.createElement("div");

    // Check if this message is from the current user
    const currentUser = "{{ user.username }}";
    const isOwnMessage = data.username === currentUser;

    messageDiv.className = `flex ${isOwnMessage ? 'justify-end' : 'justify-start'}`;
    messageDiv.innerHTML = `
      <div class="max-w-xs lg:max-w-md">
        <div class="${isOwnMessage ? 'bg-gradient-to-r from-blue-500 to-indigo-500 text-white rounded-2xl rounded-br-md' : 'bg-white border border-gray-200 text-gray-800 rounded-2xl rounded-bl-md'} px-4 py-3 shadow-md">
          <div class="font-medium text-sm mb-1">
            ${isOwnMessage ? 'You' : data.username}
          </div>
          <div class="${isOwnMessage ? 'text-white' : 'text-gray-700'}">
            ${data.message}
          </div>
          <div class="text-xs ${isOwnMessage ? 'text-blue-100' : 'text-gray-500'} mt-1">
            ${new Date().toLocaleTimeString()}
          </div>
        </div>
      </div>
    `;
    messagesContainer.appendChild(messageDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
  };

  chatSocket.onclose = function (e) {
    console.error("Chat socket closed unexpectedly");
    console.log("WebSocket close event:", e);
  };

  chatSocket.onerror = function (e) {
    console.error("WebSocket error:", e);
  };

  chatSocket.onopen = function (e) {
    console.log("WebSocket connected successfully to Redis-backed channel!");
  };

  document.querySelector("#chat-form").addEventListener("submit", function (e) {
    e.preventDefault();
    const messageInputDom = document.querySelector("#chat-message-input");
    const message = messageInputDom.value.trim();

    if (message === "") return;

    chatSocket.send(
      JSON.stringify({
        message: message,
      })
    );

    messageInputDom.value = "";
  });

  // Copy room link function
  function copyRoomLink() {
    const roomUrl = window.location.href;
    navigator.clipboard.writeText(roomUrl).then(() => {
      // Show success feedback
      const button = event.target;
      const originalText = button.innerHTML;
      button.innerHTML = '<i class="fas fa-check mr-2"></i>Copied!';
      button.className = button.className.replace('from-blue-50 to-indigo-50 text-blue-700 border-blue-200', 'from-green-50 to-emerald-50 text-green-700 border-green-200');
      
      setTimeout(() => {
        button.innerHTML = originalText;
        button.className = button.className.replace('from-green-50 to-emerald-50 text-green-700 border-green-200', 'from-blue-50 to-indigo-50 text-blue-700 border-blue-200');
      }, 2000);
    });
  }

  // Auto-scroll to bottom on page load
  document.addEventListener('DOMContentLoaded', function() {
    const messagesContainer = document.getElementById("chat-messages");
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
  });
</script>
{% endblock %}